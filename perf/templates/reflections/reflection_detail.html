{% extends "base.html" %}
{% load crispy_forms_tags static %}

{% block content %}
<div class="row">

  <!-- Left column: Reflection info -->
  <div class="col-12 col-lg-6">
    <div class="card card-primary card-outline shadow-sm">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-user"></i> {{ reflection.teacher }}
        </h3>
      </div>
      <div class="card-body">
        <p class="text-muted">
          <i class="fas fa-building"></i> {{ reflection.teacher.department }} <br>
          <i class="fas fa-calendar-alt"></i> {{ reflection.date_created|date:"d M Y" }}
        </p>

        <h5 class="mt-4 text-primary"><i class="fas fa-layer-group"></i> Reflection Domains</h5>
        {% if reflection.reflection_domains.all %}
          {% for rd in reflection.reflection_domains.all %}
            <div class="card card-light shadow-sm mb-3">
              <div class="card-body">
                <h6 class="card-title"><i class="fas fa-folder"></i> {{ rd.domain.name }}</h6>
                <p><strong>Strengths:</strong>
                  {% if rd.strengths.all %}
                    {% for s in rd.strengths.all %}
                      <span class="badge badge-success">{{ s.name }}</span>
                    {% endfor %}
                  {% else %}
                    <em class="text-muted">—</em>
                  {% endif %}
                </p>
                <p><strong>Growth Areas:</strong>
                  {% if rd.growths.all %}
                    {% for g in rd.growths.all %}
                      <span class="badge badge-warning text-dark">{{ g.name }}</span>
                    {% endfor %}
                  {% else %}
                    <em class="text-muted">—</em>
                  {% endif %}
                </p>
                <p><strong>Next Steps:</strong> {{ rd.next_steps|default:"—" }}</p>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No domains added for this reflection.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right column: Growth plans -->
  <div class="col-12 col-lg-6">
    <div class="card card-success card-outline shadow-sm">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-bullseye"></i> Growth Plans</h3>
      </div>
      <div class="card-body">

        {% if reflection.growth_plans.all %}
          <ul class="list-group mb-3">
            {% for gp in reflection.growth_plans.all %}
              <li class="list-group-item">
                <a data-toggle="collapse" href="#gp{{ gp.id }}" role="button" aria-expanded="false" aria-controls="gp{{ gp.id }}">
                  <i class="fas fa-file-alt"></i> Growth Plan {{ forloop.counter }} ({{ gp.academic_year }})
                </a>
              </li>
              <div class="collapse mt-2" id="gp{{ gp.id }}">
                <div class="card card-light shadow-sm mb-3">
                  <div class="card-body">
                    <p><b>Goal:</b> {{ gp.goal_statement }}</p>
                    <p><b>Components Addressed:</b>
                      {% for comp in gp.components_addressed.all %}
                        <span class="badge badge-info">{{ comp.name }}</span>
                      {% empty %}
                        <em class="text-muted">—</em>
                      {% endfor %}
                    </p>
                    <p><b>Indicators of Success:</b> {{ gp.indicators_of_success }}</p>
                    <p><b>Actions:</b> {{ gp.actions }}</p>
                    <p><b>Timelines:</b> {{ gp.timelines }}</p>
                    <p><b>Resources:</b> {{ gp.resources|default:"—" }}</p>
                    <p><b>Evaluator:</b> {{ gp.evaluator_name }}</p>
                    <p><b>Date:</b> {{ gp.date }}</p>

                    <!-- Observation Comments -->
                    {% if gp.observation %}
                      <div class="post">
                        <div class="user-block">
                          <img class="img-circle img-bordered-sm" src="{% static "dist/img/avatar.png" %}" alt="user image">
                          <span class="username"><a href="#">HOD's Comment</a></span>
                        </div>
                        <p>{{ gp.observation.hod_comment|default:"—" }}</p>
                      </div>

                      <div class="post">
                        <div class="user-block">
                          <img class="img-circle img-bordered-sm" src="{% static "dist/img/avatar.png" %}" alt="user image">
                          <span class="username"><a href="#">Program Coordinator's Comment</a></span>
                        </div>
                        <p>{{ gp.observation.coordinator_comment|default:"—" }}</p>
                      </div>

                      <div class="post">
                        <div class="user-block">
                          <img class="img-circle img-bordered-sm" src="{% static "dist/img/avatar.png" %}" alt="user image">
                          <span class="username"><a href="#">Vice Principal's Comment</a></span>
                        </div>
                        <p>{{ gp.observation.prin_comment|default:"—" }}</p>
                      </div>
                    {% endif %}

                    <!-- Comment Forms -->
                    {% if is_hod %}
                      <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="growth_plan_id" value="{{ gp.id }}">
                        {{ form.hod_comment|as_crispy_field }}
                        <button type="submit" class="btn btn-primary btn-sm">Save HOD Comment</button>
                      </form>
                    {% endif %}

                    {% if is_pc %}
                      <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="growth_plan_id" value="{{ gp.id }}">
                        {{ form.coordinator_comment|as_crispy_field }}
                        <button type="submit" class="btn btn-success btn-sm">Save Coordinator Comment</button>
                      </form>
                    {% endif %}

                    {% if is_prin %}
                      <form method="post" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="growth_plan_id" value="{{ gp.id }}">
                        {{ form.prin_comment|as_crispy_field }}
                        <button type="submit" class="btn btn-warning btn-sm">Save Principal Comment</button>
                      </form>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No growth plans found for this reflection.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock content %}
